<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.spring.dao.chart.IChartMapper">

	<!-- <parameterMap type="com.spring.model.chart.LineChartParam" id="param"></parameterMap> -->
	
	<resultMap type="com.spring.model.chart.LineChartModel" id="LineChartModel"></resultMap>
	<resultMap type="com.spring.model.chart.LineChartStandardValueModel" id="StandardValue"></resultMap>
	
	
	<!-- <select id="selectLineChart" parameterMap="param" resultMap="LineChartModel"> -->
	<select id="selectLineChart" parameterType="hashmap" resultMap="LineChartModel">
	<choose>
    	<when test="display_type == 'V'.toString() ">
            SELECT BODY_NO, TOR_VALUE TOR, ANG_VALUE ANG 
			FROM ${table_nm}
			WHERE PLANT_CD = RPAD(#{plant_cd},4)
			AND DEVICE_ID = RPAD(#{device_id},10) AND DEVICE_SERIAL = #{device_serial}
			AND TIGHTENING_DT &gt;= #{from_dt} AND TIGHTENING_DT &lt;= #{to_dt}
			ORDER BY TIGHTENING_DT 
        </when>
        <when test="display_type == 'A'.toString() ">
            SELECT BODY_NO, TOR, ANG 
			FROM ( 
				SELECT RK, BODY_NO, ROUND(AVG(TOR_VALUE), 2) TOR, ROUND(AVG(ANG_VALUE), 2) ANG 
				FROM ( 
					SELECT RANK() OVER (ORDER BY MAX_TD) RK, BODY_NO, TOR_VALUE, ANG_VALUE 
					FROM ( 
						SELECT BODY_NO, TOR_VALUE, ANG_VALUE, 
							(SELECT MAX(TIGHTENING_DT) FROM ${table_nm}  
							WHERE PLANT_CD = A.PLANT_CD AND DEVICE_ID = A.DEVICE_ID AND DEVICE_SERIAL = A.DEVICE_SERIAL AND BODY_NO = A.BODY_NO) MAX_TD 
						FROM ( 
							SELECT PLANT_CD, DEVICE_ID, DEVICE_SERIAL, BODY_NO, TOR_VALUE, ANG_VALUE, TIGHTENING_DT 
							FROM ${table_nm} 
							WHERE PLANT_CD = RPAD(#{plant_cd},4)
							AND DEVICE_ID = RPAD(#{device_id},10) AND DEVICE_SERIAL = #{device_serial}
							AND TIGHTENING_DT &gt;= #{from_dt} AND TIGHTENING_DT &lt;= #{to_dt}
							ORDER BY TIGHTENING_DT 
						) A 
					)
				) 
				GROUP BY RK, BODY_NO 
				ORDER BY RK, BODY_NO 
			) 
        </when>
	</choose>
	</select>
	
	<select id="selectStandardValue" parameterType="hashmap" resultMap="StandardValue">
		SELECT TORQUE_HIGH, TORQUE_OK, TORQUE_LOW,ANGLE_HIGH, ANGLE_OK, ANGLE_LOW
		FROM TIGHTENING_DEVICE_MA
		WHERE TRIM(DEVICE_ID) = #{device_id} AND TRIM(DEVICE_SERIAL) = #{device_serial}
	</select>
	

</mapper>