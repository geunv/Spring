<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.spring.dao.main.IMainMapper">
	
	<resultMap type="com.spring.model.main.MainDisconnectedTool" id="ToolList"></resultMap>
	<resultMap type="com.spring.model.main.MainToolStatus" id="ToolStatus"></resultMap>
	<resultMap type="com.spring.model.main.MainRepairConn" id="RepairStatus"></resultMap>
	<resultMap type="com.spring.model.main.MainThighteningResult" id="ThighteningResult"></resultMap>
	
	<select id="selectDisconnectedToolList" resultMap="ToolList">
	<![CDATA[
		 SELECT RTRIM(A.DEVICE_ID) AS DEVICE_ID, RTRIM(A.DEVICE_NM) || '-' || RTRIM(A.DEVICE_ALIAS) AS DEV_NM 
		 FROM   TIGHTENING_PGM_MA M 
		        INNER JOIN TIGHTENING_DEVICE_MA A ON A.PLANT_CD = M.PLANT_CD AND A.DEVICE_ID = M.DEVICE_ID AND A.DEVICE_SERIAL = M.DEVICE_SERIAL AND A.STN_GUB = M.STN_GUB 
		        LEFT OUTER JOIN C_COMM_CD B ON B.PLANT_CD = A.PLANT_CD AND B.CD_GRP = 'LINE_CD' AND B.CODE = A.LINE_CD 
		 WHERE  M.STN_GUB = 'N' 
		 AND    (M.TIGHTENING_PROC_STATUS = '0' 
		         OR A.DEVICE_STATUS_DT < TO_CHAR(SYSDATE - INTERVAL '180' SECOND, 'YYYYMMDDHH24MISS')) 
		 ORDER BY M.PLANT_CD, B.CODE_VALUE, M.PROC_NM, M.DEVICE_ID, M.DEVICE_SERIAL
	]]> 
	</select>
	
	<select id="selectToolConnectionStatus" resultMap="ToolStatus">
	<![CDATA[
		SELECT COUNT(*) AS TOTAL_TOOL_CNT, 
		       SUM(CASE WHEN M.TIGHTENING_PROC_STATUS = '1' AND A.DEVICE_STATUS_DT >= TO_CHAR(SYSDATE - INTERVAL '180' SECOND, 'YYYYMMDDHH24MISS') THEN 1 
		           ELSE 0 END) AS CONN_OK, 
		       SUM(CASE WHEN M.TIGHTENING_PROC_STATUS = '0' OR A.DEVICE_STATUS_DT < TO_CHAR(SYSDATE - INTERVAL '180' SECOND, 'YYYYMMDDHH24MISS') THEN 1 
		           ELSE 0 END) AS CONN_NG 
		FROM   TIGHTENING_PGM_MA M 
		       INNER JOIN TIGHTENING_DEVICE_MA A ON A.PLANT_CD = M.PLANT_CD AND A.DEVICE_ID = M.DEVICE_ID AND A.DEVICE_SERIAL = M.DEVICE_SERIAL AND A.STN_GUB = M.STN_GUB 
		WHERE  M.STN_GUB = 'N'
	]]>    
	</select>
	
	<select id="selectRepairToolConnStatus" resultMap="RepairStatus">
		SELECT DEVICE_NM
			, PGM_STATUS, 
			DECODE(PGM_STATUS, 0, 'N',(DECODE(SIGN(((SYSDATE-TO_DATE(NVL(TRIM(DEVICE_STATUS_DT), '19990101090000'), 'YYYYMMDDHH24MISS'))*24*60)-3), 0, 'N', DEVICE_STATUS))) TOOL_STATUS 
		FROM ( 
			SELECT A.LINE_CD,  
				(SELECT DECODE(SIGN(((SYSDATE-TO_DATE(NVL(TRIM(TIGHTENING_PROC_DT), '19990101090000'), 'YYYYMMDDHH24MISS'))*24*60)-3), 1, '0', TIGHTENING_PROC_STATUS) 
				FROM TIGHTENING_PGM_MA 
				WHERE STN_GUB = 'R' AND DEVICE_ID = B.DEVICE_ID AND DEVICE_SERIAL = B.DEVICE_SERIAL  ) PGM_STATUS,
			B.DEVICE_STATUS, 
			B.DEVICE_STATUS_DT, 
			B.DEVICE_NM,    
			CASE B.LINE_CD 
				WHEN 'T1' THEN 1 
				WHEN 'T2' THEN 2 
				WHEN 'C1' THEN 3 
				WHEN 'CM' THEN 4 
				WHEN 'C2' THEN 5 
				WHEN 'F1' THEN 6 
				WHEN 'F2' THEN 7 
				WHEN 'F3' THEN 8 
				WHEN 'OK' THEN 9 
				END AS LINE_ORDER 
			FROM  (SELECT CODE, CODE_NM LINE_CD FROM C_COMM_CD WHERE CD_GRP = 'LINE_CD' ) A,  
				  (SELECT LINE_CD, DEVICE_ID, DEVICE_SERIAL, DEVICE_STATUS, DEVICE_STATUS_DT, DEVICE_NM FROM TIGHTENING_DEVICE_MA WHERE STN_GUB = 'R') B  
					WHERE A.CODE = B.LINE_CD  
			ORDER BY LINE_ORDER, DEVICE_NM   
		) 
	</select>
	
	<select id="selectThighteningResult" resultMap="ThighteningResult">
<!-- 	SELECT TO_CHAR(SYSDATE, 'YYYYMMDD') DAY, 
	(SELECT NVL(SUM(TOTAL_CNT - PASS_CNT), 0) FROM TIGHTENING_SUM_HI WHERE WORK_DT = TO_CHAR(SYSDATE, 'YYYYMMDD')) TOTAL, 
	(SELECT NVL(SUM(OK_CNT), 0) FROM TIGHTENING_SUM_HI WHERE WORK_DT = TO_CHAR(SYSDATE, 'YYYYMMDD')) OK, 
	(SELECT NVL(SUM(NG_CNT - REPAIR_CNT), 0) FROM TIGHTENING_SUM_HI WHERE WORK_DT = TO_CHAR(SYSDATE, 'YYYYMMDD')) NG, 
	(SELECT NVL(SUM(NOSCAN_CNT), 0) FROM TIGHTENING_SUM_HI WHERE WORK_DT = TO_CHAR(SYSDATE, 'YYYYMMDD')) NOSCAN, 
	(SELECT NVL(SUM(REPAIR_CNT), 0) FROM TIGHTENING_SUM_HI WHERE WORK_DT = TO_CHAR(SYSDATE, 'YYYYMMDD')) REPAIR, 
	(SELECT COUNT(1) FROM PLC_INTERLOCK_HI WHERE INTERLOCK_DT = TO_CHAR(SYSDATE, 'YYYYMMDD') AND INTERLOCK_FLG = 'Y') INTERLOCK 
	FROM DUAL 
	UNION 
	SELECT TO_CHAR(SYSDATE-1, 'YYYYMMDD') DAY, 
	(SELECT NVL(SUM(TOTAL_CNT- PASS_CNT), 0) FROM TIGHTENING_SUM_HI WHERE WORK_DT = TO_CHAR(SYSDATE-1, 'YYYYMMDD')) TOTAL, 
	(SELECT NVL(SUM(OK_CNT), 0) FROM TIGHTENING_SUM_HI WHERE WORK_DT = TO_CHAR(SYSDATE-1, 'YYYYMMDD')) OK, 
	(SELECT NVL(SUM(NG_CNT - REPAIR_CNT), 0) FROM TIGHTENING_SUM_HI WHERE WORK_DT = TO_CHAR(SYSDATE-1, 'YYYYMMDD')) NG, 
	(SELECT NVL(SUM(NOSCAN_CNT), 0) FROM TIGHTENING_SUM_HI WHERE WORK_DT = TO_CHAR(SYSDATE-1, 'YYYYMMDD')) NOSCAN, 
	(SELECT NVL(SUM(REPAIR_CNT), 0) FROM TIGHTENING_SUM_HI WHERE WORK_DT = TO_CHAR(SYSDATE-1, 'YYYYMMDD')) REPAIR, 
	(SELECT COUNT(1) FROM PLC_INTERLOCK_HI WHERE INTERLOCK_DT = TO_CHAR(SYSDATE-1, 'YYYYMMDD') AND INTERLOCK_FLG = 'Y') INTERLOCK 
	FROM DUAL 
	ORDER BY DAY --> 

	SELECT TO_CHAR(TO_DATE('2017-07-13'), 'YYYYMMDD') DAY, 
		(SELECT NVL(SUM(TOTAL_CNT - PASS_CNT), 0) FROM TIGHTENING_SUM_HI WHERE WORK_DT = TO_CHAR(TO_DATE('2017-07-13'), 'YYYYMMDD')) TOTAL, 
		(SELECT NVL(SUM(OK_CNT), 0) FROM TIGHTENING_SUM_HI WHERE WORK_DT = TO_CHAR(TO_DATE('2017-07-13'), 'YYYYMMDD')) OK, 
		(SELECT NVL(SUM(NG_CNT - REPAIR_CNT), 0) FROM TIGHTENING_SUM_HI WHERE WORK_DT = TO_CHAR(TO_DATE('2017-07-13'), 'YYYYMMDD')) NG, 
		(SELECT NVL(SUM(NOSCAN_CNT), 0) FROM TIGHTENING_SUM_HI WHERE WORK_DT = TO_CHAR(TO_DATE('2017-07-13'), 'YYYYMMDD')) NOSCAN, 
		(SELECT NVL(SUM(REPAIR_CNT), 0) FROM TIGHTENING_SUM_HI WHERE WORK_DT = TO_CHAR(TO_DATE('2017-07-13'), 'YYYYMMDD')) REPAIR, 
		(SELECT COUNT(1) FROM PLC_INTERLOCK_HI WHERE INTERLOCK_DT = TO_CHAR(TO_DATE('2017-07-13'), 'YYYYMMDD') AND INTERLOCK_FLG = 'Y') INTERLOCK 
	FROM DUAL 
	UNION 
	SELECT TO_CHAR(TO_DATE('2017-07-13')-1, 'YYYYMMDD') DAY, 
		(SELECT NVL(SUM(TOTAL_CNT- PASS_CNT), 0) FROM TIGHTENING_SUM_HI WHERE WORK_DT = TO_CHAR(TO_DATE('2017-07-13')-1, 'YYYYMMDD')) TOTAL, 
		(SELECT NVL(SUM(OK_CNT), 0) FROM TIGHTENING_SUM_HI WHERE WORK_DT = TO_CHAR(TO_DATE('2017-07-13')-1, 'YYYYMMDD')) OK, 
		(SELECT NVL(SUM(NG_CNT - REPAIR_CNT), 0) FROM TIGHTENING_SUM_HI WHERE WORK_DT = TO_CHAR(TO_DATE('2017-07-13')-1, 'YYYYMMDD')) NG, 
		(SELECT NVL(SUM(NOSCAN_CNT), 0) FROM TIGHTENING_SUM_HI WHERE WORK_DT = TO_CHAR(TO_DATE('2017-07-13')-1, 'YYYYMMDD')) NOSCAN, 
		(SELECT NVL(SUM(REPAIR_CNT), 0) FROM TIGHTENING_SUM_HI WHERE WORK_DT = TO_CHAR(TO_DATE('2017-07-13')-1, 'YYYYMMDD')) REPAIR, 
		(SELECT COUNT(1) FROM PLC_INTERLOCK_HI WHERE INTERLOCK_DT = TO_CHAR(TO_DATE('2017-07-13')-1, 'YYYYMMDD') AND INTERLOCK_FLG = 'Y') INTERLOCK 
	FROM DUAL 
	ORDER BY DAY 
	</select>
</mapper>